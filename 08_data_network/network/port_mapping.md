## 外部訪問容器

### 為什麼要對映連接埠

容器執行在自己的隔離網路環境中（通常是 Bridge 模式）。這意味著：
- **容器之間**：可以透過 IP 或容器名（自定義網路）互通。
- **宿主機訪問容器**：可以透過容器 IP 訪問。
- **外部網路訪問容器**：❌ 預設無法直接訪問。

為了讓外部（如你的瀏覽器、其他區域網路機器）訪問容器內的服務，我們需要將容器的連接埠**對映**到宿主機的連接埠。

```
       外部使用者 (Browser)
             │
             ▼
      宿主機 (localhost:8080)
             │
        ┌────┴────┐ 連接埠對映
        │ Docker  │ (8080 -> 80)
        │  Proxy  │
        └────┬────┘
             │
             ▼
       容器 (Class B: 80)
```

---

### 連接埠對映方式

#### 1. 指定對映

Docker 提供了多種方式來指定連接埠對映，最常用的是 `-p` 引數。


使用 `-p <宿主機連接埠>:<容器連接埠>` 格式。

```bash
## 將宿主機的 8080 連接埠對映到容器的 80 連接埠

$ docker run -d -p 8080:80 nginx
```

此時訪問 `http://localhost:8080` 即可看到 Nginx 頁面。

**多種格式**：

| 格式 | 含義 | 範例 |
|------|------|------|
| `ip:hostPort:containerPort` | 繫結指定 IP 的特定連接埠 | `-p 127.0.0.1:8080:80` (僅本機訪問) |
| `ip::containerPort` | 繫結指定 IP 的隨機連接埠 | `-p 127.0.0.1::80` |
| `hostPort:containerPort` | 繫結所有 IP (0.0.0.0) 的特定連接埠 | `-p 8080:80` (預設) |
| `containerPort` | 繫結所有 IP 的隨機連接埠 | `-p 80` |

#### 2. 隨機對映

如果您不關心宿主機使用哪個連接埠，可以使用隨機對映功能。


使用 `-P` (大寫) 引數，Docker 會隨機對映 Dockerfile 中 `EXPOSE` 指令暴露的所有連接埠到宿主機的高連接埠（49000-49900）。

```bash
$ docker run -d -P nginx
```

檢視對映結果：

```bash
$ docker ps
CONTAINER ID   PORTS
abc123456      0.0.0.0:49153->80/tcp
```

此時 Nginx 被對映到了宿主機的 49153 連接埠。

---

### 檢視連接埠對映

#### docker port

我們可以使用 `docker port` 指令來檢視當前容器的連接埠對映規則。


執行以下指令：

```bash
$ docker port mycontainer
80/tcp -> 0.0.0.0:8080
80/tcp -> [::]:8080
```

#### docker ps

執行以下指令：

```bash
$ docker ps
CONTAINER ID   IMAGE     PORTS                  NAMES
abc123456      nginx     0.0.0.0:8080->80/tcp   web
```

---

### 最佳實踐與安全

#### 1. 限制監聽 IP

為了保證服務的安全性，我們應該謹慎選擇繫結的 IP 地址。


預設情況下，`-p 8080:80` 會監聽 `0.0.0.0:8080`，這意味著任何人只要能連線你的宿主機 IP，就能訪問該服務。

如果不希望對外暴露（例如資料庫服務），應繫結到 `127.0.0.1`：

```bash
## 僅允許本機訪問

$ docker run -d -p 127.0.0.1:3306:3306 mysql
```

#### 2. 避免連接埠衝突

如果宿主機 8080 已經被佔用了，容器將無法啟動。

**解決**：
- 更換宿主機連接埠：`-p 8081:80`
- 讓 Docker 自動分配：`-p 80`

#### 3. UDP 對映

預設是 TCP 協定。如果要對映 UDP 服務（如 DNS, Syslog）：

```bash
$ docker run -d -p 53:53/udp dns-server
```

---

### 實現原理

Docker 使用 `docker-proxy` 程序（使用者態）或 `iptables` DNAT 規則（核心態）來實現連接埠轉發。

當流量到達宿主機連接埠時，iptables 規則將其目標地址修改為容器 IP 並轉發：

```bash
## 簡化的 iptables 邏輯

iptables -t nat -A DOCKER -p tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80
```

這也是為什麼你在容器內部看到的訪問來源 IP 通常是閘道器 IP（如 172.17.0.1），而不是真實的外部 Client IP（除非使用 host 網路模式）。

---

### 本章小結

| 要點 | 說明 |
|------|------|
| **-p** | 指定連接埠對映（常用），如 `8080:80` |
| **-P** | 隨機對映所有 EXPOSE 的連接埠 |
| **安全性** | 預設監聽所有 IP，敏感服務應繫結 `127.0.0.1` |
| **檢視** | 使用 `docker port` 或 `docker ps` |

### 延伸閱讀

- [EXPOSE 指令](../07_dockerfile/7.9_expose.md)：在 Dockerfile 中宣告連接埠
- [網路模式](README.md)：Host 模式不需要連接埠對映
