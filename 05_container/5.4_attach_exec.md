## 5.4 é€²å…¥å®¹å™¨

æœ¬ç¯€æ¶µè“‹äº†ç›¸é—œå…§å®¹èˆ‡è©³ç´°æè¿°ï¼Œä¸»è¦æ¢è¨ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š

### ç‚ºä»€éº¼éœ€è¦é€²å…¥å®¹å™¨

ä½¿ç”¨ `-d` å¼•æ•¸å•Ÿå‹•å®¹å™¨å¾Œï¼Œå®¹å™¨åœ¨å¾Œå°åŸ·è¡Œã€‚ä»¥ä¸‹å ´æ™¯éœ€è¦é€²å…¥å®¹å™¨å…§éƒ¨æ“ä½œï¼š

| å ´æ™¯ | ç¯„ä¾‹ |
|------|------|
| **é™¤éŒ¯å•é¡Œ** | æª¢è¦–æ—¥èªŒã€æª¢æŸ¥è¨­å®šã€æ’æŸ¥éŒ¯èª¤ |
| **è‡¨æ™‚æ“ä½œ** | åŸ·è¡Œè³‡æ–™åº«é·ç§»ã€æ¸…ç†å¿«å– |
| **æª¢æŸ¥ç‹€æ…‹** | æª¢è¦–ç¨‹åºã€ç¶²è·¯é€£ç·šã€æª”æ¡ˆç³»çµ± |
| **é–‹ç™¼æ¸¬è©¦** | äº’å‹•å¼æ¸¬è©¦æŒ‡ä»¤ã€é©—è­‰ç’°å¢ƒ |

### å…©ç¨®é€²å…¥æ–¹å¼

Docker æä¾›å…©ç¨®é€²å…¥å®¹å™¨çš„æŒ‡ä»¤ï¼š

| æŒ‡ä»¤ | æ¨è–¦ç¨‹åº¦ | ç‰¹é» |
|------|---------|------|
| `docker exec` | âœ… **æ¨è–¦** | å•Ÿå‹•æ–°é€²ç¨‹ï¼Œé€€å‡ºä¸å½±éŸ¿å®¹å™¨ |
| `docker attach` | âš ï¸ è¬¹æ…ä½¿ç”¨ | é™„åŠ åˆ°ä¸»ç¨‹åºï¼Œé€€å‡ºå¯èƒ½åœæ­¢å®¹å™¨ |

---

### docker exec (æ¨è–¦)

æœ¬ç¯€æ¶µè“‹äº†ç›¸é—œå…§å®¹èˆ‡è©³ç´°æè¿°ï¼Œä¸»è¦æ¢è¨ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š

#### docker exec åŸºæœ¬ç”¨æ³•

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## é€²å…¥å®¹å™¨ä¸¦å•Ÿå‹•äº’å‹•å¼ shell

$ docker exec -it å®¹å™¨å /bin/bash

## æˆ–ä½¿ç”¨ shï¼ˆé©ç”¨æ–¼ Alpine ç­‰ç²¾ç°¡æ˜ è±¡ï¼‰

$ docker exec -it å®¹å™¨å /bin/sh
```

#### å¼•æ•¸èªªæ˜

ç›¸é—œè¨Šæ¯å¦‚ä¸‹è¡¨ï¼š

| å¼•æ•¸ | ä½œç”¨ |
|------|------|
| `-i` | ä¿æŒæ¨™æº–è¼¸å…¥é–‹å•Ÿ (interactive)|
| `-t` | åˆ†é…å½çµ‚ç«¯ (TTY)|
| `-it` | å…©è€…çµ„åˆï¼Œç²å¾—å®Œæ•´äº’å‹•é«”é©— |
| `-u` | æŒ‡å®šä½¿ç”¨è€… (å¦‚ `-u root`)|
| `-w` | æŒ‡å®šå·¥ä½œç›®éŒ„ |
| `-e` | è¨­å®šç’°å¢ƒè®Šæ•¸ |

#### docker exec ç¯„ä¾‹

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å•Ÿå‹•ä¸€å€‹å¾Œå°å®¹å™¨

$ docker run -dit --name myubuntu ubuntu
69d137adef7a...

## é€²å…¥å®¹å™¨ï¼ˆäº’å‹•å¼ shellï¼‰

$ docker exec -it myubuntu bash
root@69d137adef7a:/# ls
bin  boot  dev  etc  home  lib  ...
root@69d137adef7a:/# exit

## å®¹å™¨ä»åœ¨åŸ·è¡Œï¼

$ docker ps
CONTAINER ID   IMAGE    STATUS         NAMES
69d137adef7a   ubuntu   Up 2 minutes   myubuntu
```

#### åŸ·è¡Œå–®æ¢æŒ‡ä»¤

ä¸é€²å…¥äº’å‹•æ¨¡å¼ï¼Œç›´æ¥åŸ·è¡ŒæŒ‡ä»¤ï¼š

```bash
## æª¢è¦–å®¹å™¨å…§ç¨‹åº

$ docker exec myubuntu ps aux

## æª¢è¦–è¨­å®šæª”æ¡ˆ

$ docker exec myubuntu cat /etc/nginx/nginx.conf

## ä»¥ root ä½¿ç”¨è€…åŸ·è¡Œ

$ docker exec -u root myubuntu apt update
```

#### åªç”¨ -i ä¸ç”¨ -t çš„å€åˆ¥

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## åªç”¨ -iï¼šå¯ä»¥åŸ·è¡ŒæŒ‡ä»¤ï¼Œä½†æ²’æœ‰æç¤ºç¬¦

$ docker exec -i myubuntu bash
ls           # è¼¸å…¥æŒ‡ä»¤
bin          # è¼¸å‡ºçµæœ
boot
dev
...

## ç”¨ -itï¼šæœ‰å®Œæ•´çš„çµ‚ç«¯é«”é©—

$ docker exec -it myubuntu bash
root@69d137adef7a:/#    # æœ‰æç¤ºç¬¦
```

> ğŸ’¡ é€šå¸¸ä½¿ç”¨ `-it` çµ„åˆã€‚åªæœ‰åœ¨æŒ‡ä»¤ç¢¼ä¸­éœ€è¦é€éé€šé“å‚³å…¥æŒ‡ä»¤æ™‚æ‰åªç”¨ `-i`ã€‚

---

### docker attach (è¬¹æ…ä½¿ç”¨)

æœ¬ç¯€æ¶µè“‹äº†ç›¸é—œå…§å®¹èˆ‡è©³ç´°æè¿°ï¼Œä¸»è¦æ¢è¨ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š

#### docker attach åŸºæœ¬ç”¨æ³•

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
$ docker attach å®¹å™¨å
```

#### å·¥ä½œåŸç†

`attach` æœƒé™„åŠ åˆ°å®¹å™¨çš„ **ä¸»ç¨‹åº** (PID 1) çš„æ¨™æº–è¼¸å…¥è¼¸å‡ºï¼š

```mermaid
flowchart LR
    subgraph Container ["å®¹å™¨"]
        direction TB
        subgraph Process ["ä¸»ç¨‹åº"]
            P1["PID 1: /bin/bash<br>(ä½ çš„è¼¸å…¥ç›´æ¥å‚³é€åˆ°ä¸»ç¨‹åº)"]
        end
    end
    Attach["docker attach"] -->|"é™„åŠ åˆ°é€™è£¡"| P1
```

#### docker attach ç¯„ä¾‹

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å•Ÿå‹•å®¹å™¨

$ docker run -dit --name myubuntu ubuntu
243c32535da7...

## é™„åŠ åˆ°å®¹å™¨

$ docker attach myubuntu
root@243c32535da7:/#
```

#### âš ï¸ é‡è¦è­¦å‘Š

**å¾ attach æœƒè©±ä¸­è¼¸å…¥ `exit` æˆ–æŒ‰ `Ctrl+D` æœƒå°è‡´å®¹å™¨åœæ­¢ï¼**

```bash
$ docker attach myubuntu
root@243c32535da7:/# exit    # é€™æœƒåœæ­¢å®¹å™¨ï¼

$ docker ps
CONTAINER ID   IMAGE    STATUS                     NAMES
243c32535da7   ubuntu   Exited (0) 2 seconds ago   myubuntu
```

**åŸå› **ï¼šattach é™„åŠ åˆ°ä¸»ç¨‹åºï¼Œé€€å‡ºä¸»ç¨‹åºå°±ç­‰æ–¼é€€å‡ºå®¹å™¨ã€‚

#### å®‰å…¨é€€å‡º attach

ä½¿ç”¨ `Ctrl+P` ç„¶å¾Œ `Ctrl+Q` å¯ä»¥å¾ attach æœƒè©±ä¸­ **åˆ†é›¢**ï¼Œè€Œä¸åœæ­¢å®¹å™¨ï¼š

```bash
$ docker attach myubuntu
root@243c32535da7:/# 
## æŒ‰ Ctrl+P ç„¶å¾Œ Ctrl+Q

read escape sequence

$ docker ps    # å®¹å™¨ä»åœ¨åŸ·è¡Œ
CONTAINER ID   IMAGE    STATUS         NAMES
243c32535da7   ubuntu   Up 5 minutes   myubuntu
```

---

### exec vs attach å°æ¯”

ç›¸é—œè¨Šæ¯å¦‚ä¸‹è¡¨ï¼š

| å±¬æ€§ | docker exec | docker attach |
|------|-------------|---------------|
| **å·¥ä½œæ–¹å¼** | åœ¨å®¹å™¨å…§å•Ÿå‹•æ–°é€²ç¨‹ | é™„åŠ åˆ°ä¸»ç¨‹åº |
| **é€€å‡ºå½±éŸ¿** | ä¸å½±éŸ¿å®¹å™¨ | å¯èƒ½åœæ­¢å®¹å™¨ |
| **å¤šçµ‚ç«¯** | å¯ä»¥é–‹å¤šå€‹ | å…±äº«åŒä¸€å€‹æœƒè©± |
| **é©ç”¨å ´æ™¯** | é™¤éŒ¯ã€è‡¨æ™‚æ“ä½œ | æª¢è¦–ä¸»ç¨‹åºè¼¸å‡º |
| **æ¨è–¦ç¨‹åº¦** | âœ… æ¨è–¦ | âš ï¸ ç‰¹æ®Šå ´æ™¯ä½¿ç”¨ |

```mermaid
flowchart LR
    subgraph Exec ["docker exec"]
        direction TB
        subgraph Container1 ["å®¹å™¨"]
            E_PID1["PID 1: nginx"]
            E_PID50["PID 50: bash"]
        end
        NewProc["æ–°é€²ç¨‹"] -- é™„åŠ åˆ° --> E_PID50
    end
    
    subgraph Attach ["docker attach"]
        direction TB
        subgraph Container2 ["å®¹å™¨"]
            A_PID1["PID 1: bash"]
        end
        MainProc["é™„åŠ åˆ°ä¸»ç¨‹åº"] --> A_PID1
    end
    
    note1["é€€å‡º bash ä¸å½±éŸ¿ nginx"]
    note2["é€€å‡º bash å®¹å™¨åœæ­¢"]
    Container1 -.-> note1
    Container2 -.-> note2
```

---

### æœ€ä½³å¯¦è¸

æœ¬ç¯€æ¶µè“‹äº†ç›¸é—œå…§å®¹èˆ‡è©³ç´°æè¿°ï¼Œä¸»è¦æ¢è¨ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š

#### 1ã€‚é¦–é¸ docker exec

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## é€²å…¥å®¹å™¨é™¤éŒ¯

$ docker exec -it myapp bash

## æª¢è¦–æ—¥èªŒ

$ docker exec myapp tail -f /var/log/app.log

## åŸ·è¡Œè³‡æ–™åº«é·ç§»

$ docker exec myapp python manage.py migrate
```

#### 2ã€‚ç”Ÿç”¢ç’°å¢ƒé¿å…é€²å…¥å®¹å™¨

ç­†è€…å»ºè­°ï¼šç”Ÿç”¢ç’°å¢ƒæ‡‰å„˜é‡é¿å…é€²å…¥å®¹å™¨ç›´æ¥æ“ä½œï¼Œè€Œæ˜¯é€éï¼š

- æ—¥èªŒç³»çµ±æª¢è¦–æ—¥èªŒ (å¦‚ `docker logs` æˆ–é›†ä¸­å¼æ—¥èªŒ)
- ç›£æ§ç³»çµ±æª¢è¦–ç‹€æ…‹
- é‡æ–°éƒ¨ç½²è€Œéæ‰‹å‹•ä¿®æ”¹

#### 3ã€‚ç„¡ shell æ˜ è±¡çš„è™•ç†

æŸäº›ç²¾ç°¡æ˜ è±¡ (å¦‚åŸºæ–¼ `scratch` æˆ– `distroless`) æ²’æœ‰ shellï¼š

```bash
## é€™æœƒå¤±æ•—

$ docker exec -it myapp bash
OCI runtime exec failed: exec failed: unable to start container process: exec: "bash": executable file not found

## è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨é™¤éŒ¯å®¹å™¨ï¼ˆDocker Desktop æˆ– Kubernetes debugï¼‰

$ docker debug myapp
```

---

### å¸¸è¦‹å•é¡Œ

æœ¬ç¯€æ¶µè“‹äº†ç›¸é—œå…§å®¹èˆ‡è©³ç´°æè¿°ï¼Œä¸»è¦æ¢è¨ä»¥ä¸‹å¹¾å€‹æ–¹é¢ï¼š

#### Qï¼šexec é€²å…¥å¾Œçœ‹ä¸åˆ°å…¶ä»–çµ‚ç«¯çš„æ“ä½œ

é€™æ˜¯æ­£å¸¸çš„ã€‚exec å•Ÿå‹•çš„æ˜¯ç¨ç«‹ç¨‹åºï¼Œå¤šå€‹ exec æœƒè©±äº’ä¸å½±éŸ¿ã€‚

#### Qï¼šå®¹å™¨æ²’æœ‰ bash

å˜—è©¦ä½¿ç”¨ shï¼š

```bash
$ docker exec -it myapp /bin/sh
```

#### Qï¼šéœ€è¦ root è¨±å¯æ¬Š

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
$ docker exec -u root -it myapp bash
```

---
