## 14.2 å‘½åç©ºé–“

å‘½åç©ºé–“ï¼ˆNamespaceï¼‰æ˜¯ Linux æ ¸å¿ƒçš„ä¸€å€‹å¼·å¤§å±¬æ€§ï¼Œç‚ºå®¹å™¨æä¾›äº†éš”é›¢çš„åŸ·è¡Œç’°å¢ƒã€‚

### ä»€éº¼æ˜¯ Namespace

> **Namespace æ˜¯ Linux æ ¸å¿ƒæä¾›çš„è³‡æºéš”é›¢æ©Ÿåˆ¶ï¼Œå®ƒè®“å®¹å™¨å…§çš„ç¨‹åºé«£é«´åŸ·è¡Œåœ¨ç¨ç«‹çš„ä½œæ¥­ç³»çµ±ä¸­ã€‚**

Namespace æ˜¯å®¹å™¨æŠ€è¡“çš„æ ¸å¿ƒåŸºç¤ä¹‹ä¸€ã€‚å®ƒå›ç­”äº†ä¸€å€‹é—œéµå•é¡Œï¼š**å¦‚ä½•è®“ä¸€å€‹ç¨‹åº"ä»¥ç‚º"è‡ªå·±ç¨ä½”æ•´å€‹ç³»çµ±ï¼Ÿ**

```
å®¿ä¸»æ©Ÿè¦–è§’ï¼š                     å®¹å™¨å…§è¦–è§’ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PID 1: systemd         â”‚     â”‚  PID 1: nginx           â”‚ â† å®¹å™¨èªç‚ºè‡ªå·±æ˜¯ PID 1
â”‚  PID 2: sshd            â”‚     â”‚  PID 2: nginx worker    â”‚
â”‚  PID 3: dockerd         â”‚     â”‚                         â”‚
â”‚  PID 1234: nginx â†â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”‚  ï¼ˆå¯¦éš›æ˜¯å®¿ä¸»æ©Ÿçš„ 1234ï¼‰ â”‚
â”‚  PID 1235: nginx worker â”‚     â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Namespace çš„å‹åˆ¥

Linux æ ¸å¿ƒæä¾›äº†ä»¥ä¸‹å¹¾ç¨® Namespaceï¼ŒDocker å®¹å™¨ä½¿ç”¨äº†å…¨éƒ¨ï¼š

| Namespace | éš”é›¢å…§å®¹ | å®¹å™¨ä¸­çš„æ•ˆæœ |
|-----------|---------|-------------|
| **PID** | ç¨‹åº ID | å®¹å™¨å…§ PID å¾ 1 é–‹å§‹ï¼Œçœ‹ä¸åˆ°å…¶ä»–å®¹å™¨å’Œå®¿ä¸»æ©Ÿç¨‹åº |
| **NET** | ç¶²è·¯æ£§ | ç¨ç«‹çš„ç¶²çµ¡å¡ã€IP åœ°å€ã€é€£æ¥åŸ ã€è·¯ç”±è¡¨ |
| **MNT** | æ›è¼‰é» | ç¨ç«‹çš„æª”æ¡ˆç³»çµ±æª¢è¦–ï¼Œè‡ªå·±çš„æ ¹ç›®éŒ„ |
| **UTS** | ä¸»æ©Ÿå | ç¨ç«‹çš„ä¸»æ©Ÿåå’Œç¶²åŸŸåç¨± |
| **IPC** | ç¨‹åºé–“é€šè¨Š | ç¨ç«‹çš„è¨Šè™Ÿé‡ã€è¨Šæ¯ä½‡åˆ—ã€å…±äº«è¨˜æ†¶é«” |
| **USER** | ä½¿ç”¨è€…/çµ„ ID | å®¹å™¨å…§çš„ root å¯ä»¥å°æ˜ ç‚ºå®¿ä¸»æ©Ÿçš„æ™®é€šä½¿ç”¨è€… |
| **Cgroup** | Cgroup æ ¹ç›®éŒ„ | éš”é›¢ cgroup å±¤ç´šæª¢è¦–ï¼ˆLinux 4.6+ï¼‰ |

---

### PID Namespace

PID Namespace è² è²¬ç¨‹åº ID çš„éš”é›¢ï¼Œä½¿å¾—å®¹å™¨å…§çš„ç¨‹åºå½¼æ­¤ä¸å¯è¦‹ã€‚

#### ä½œç”¨

éš”é›¢ç¨‹åº IDï¼Œè®“æ¯å€‹å®¹å™¨æœ‰è‡ªå·±çš„ç¨‹åºç·¨è™Ÿç©ºé–“ã€‚

#### æ•ˆæœ

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å®¿ä¸»æ©Ÿä¸Šæª¢è¦–ç¨‹åº

$ ps aux | grep nginx
root     12345  0.0  0.1  nginx: master process
root     12346  0.0  0.1  nginx: worker process

## å®¹å™¨å…§æª¢è¦–ç¨‹åº

$ docker exec mycontainer ps aux
PID   USER     COMMAND
  1   root     nginx: master process    â† åœ¨å®¹å™¨å…§æ˜¯ PID 1
  2   root     nginx: worker process
```

#### é—œéµé»

- å®¹å™¨å…§çš„ PID 1 ç¨‹åºç‰¹æ®Šé‡è¦â€”â€”å®ƒæ˜¯å®¹å™¨çš„ä¸»ç¨‹åºï¼Œé€€å‡ºå‰‡å®¹å™¨åœæ­¢
- å®¹å™¨å…§ç„¡æ³•çœ‹åˆ°å®¿ä¸»æ©Ÿæˆ–å…¶ä»–å®¹å™¨çš„ç¨‹åº
- å®¿ä¸»æ©Ÿå¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨å…§çš„ç¨‹åºï¼ˆä½† PID ä¸åŒï¼‰

---

### NET Namespace

NET Namespace è² è²¬ç¶²è·¯æ£§çš„éš”é›¢ï¼ŒåŒ…æ‹¬ç¶²çµ¡å¡ã€è·¯ç”±è¡¨å’Œ iptables è¦å‰‡ç­‰ã€‚

#### ä½œç”¨

éš”é›¢ç¶²è·¯æ£§ï¼Œæ¯å€‹å®¹å™¨æ“æœ‰ç¨ç«‹çš„ç¶²è·¯ç’°å¢ƒã€‚

#### æ•ˆæœ

å…·é«”å…§å®¹å¦‚ä¸‹ï¼š

```
å®¿ä¸»æ©Ÿ                           å®¹å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  eth0: 192.168.1.10 â”‚         â”‚  eth0: 172.17.0.2   â”‚ â† ä¸åŒçš„ IP
â”‚  docker0: 172.17.0.1â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (veth pair é€£ç·š)    â”‚
â”‚  é€£æ¥åŸ  80 å¯ç”¨        â”‚         â”‚  é€£æ¥åŸ  80 å¯ç”¨        â”‚ â† å¯ä»¥ä½¿ç”¨ç›¸åŒé€£æ¥åŸ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é—œéµé»

- æ¯å€‹å®¹å™¨æœ‰ç¨ç«‹çš„ç¶²çµ¡å¡ã€IPã€è·¯ç”±è¡¨ã€iptables è¦å‰‡
- å¤šå€‹å®¹å™¨å¯ä»¥ç›£è½ç›¸åŒé€£æ¥åŸ ï¼ˆå¦‚éƒ½ç›£è½ 80ï¼‰
- Docker ä½¿ç”¨ veth pair é€£ç·šå®¹å™¨ç¶²è·¯å’Œå®¿ä¸»æ©Ÿç¶²æ©‹

---

### MNT Namespace

MNT Namespace è² è²¬æª”æ¡ˆç³»çµ±æ›è¼‰é»çš„éš”é›¢ï¼Œç¢ºä¿å®¹å™¨çœ‹åˆ°ç¨ç«‹çš„æª”æ¡ˆç³»çµ±æª¢è¦–ã€‚

#### ä½œç”¨

éš”é›¢æª”æ¡ˆç³»çµ±æ›è¼‰é»ï¼Œæ¯å€‹å®¹å™¨æœ‰è‡ªå·±çš„æ ¹ç›®éŒ„ã€‚

#### æ•ˆæœ

å…·é«”å…§å®¹å¦‚ä¸‹ï¼š

```
å®¿ä¸»æ©Ÿæª”æ¡ˆç³»çµ±ï¼š                  å®¹å™¨å…§çœ‹åˆ°çš„ï¼š
/                               /  â† å®¹å™¨çš„æ ¹ç›®éŒ„
â”œâ”€â”€ bin/                        â”œâ”€â”€ bin/
â”œâ”€â”€ home/                       â”œâ”€â”€ home/
â”œâ”€â”€ var/                        â”œâ”€â”€ var/
â”‚   â””â”€â”€ lib/                    â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ docker/             â”‚
â”‚           â””â”€â”€ overlay2/       â”‚
â”‚               â””â”€â”€ merged/ â”€â”€â”€â”€â”¼â”€â”€â”€ é€™å€‹ç›®éŒ„æˆç‚ºå®¹å™¨çš„ /
â””â”€â”€ ...                         â””â”€â”€ ...
```

#### èˆ‡ chroot çš„å€åˆ¥

| å±¬æ€§ | chroot | MNT Namespace |
|------|--------|---------------|
| å®‰å…¨æ€§ | å¯ä»¥é€ƒé€¸ | æ›´å®‰å…¨ |
| æ›è¼‰éš”é›¢ | ç„¡ | å®Œå…¨éš”é›¢ |
| /proc/mounts | å…±äº« | ç¨ç«‹ |

---

### UTS Namespace

UTS Namespace ä¸»è¦ç”¨æ–¼éš”é›¢ä¸»æ©Ÿåå’Œç¶²åŸŸåç¨±ã€‚

#### ä½œç”¨

éš”é›¢ä¸»æ©Ÿåå’Œç¶²åŸŸåç¨±ï¼Œè®“æ¯å€‹å®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ä¸»æ©Ÿåã€‚

#### æ•ˆæœ

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å®¿ä¸»æ©Ÿ

$ hostname
my-server

## å®¹å™¨å…§

$ docker run --hostname mycontainer ubuntu hostname
mycontainer
```

UTS = "UNIX Time-sharing System"ï¼Œæ˜¯æ­·å²éºç•™çš„åç¨±ã€‚

---

### IPC Namespace

IPC Namespace ç”¨æ–¼éš”é›¢ç¨‹åºé–“é€šè¨Šè³‡æºï¼Œå¦‚ System V IPC å’Œ POSIX è¨Šæ¯ä½‡åˆ—ã€‚

#### ä½œç”¨

éš”é›¢ System V IPC å’Œ POSIX è¨Šæ¯ä½‡åˆ—ã€‚

#### éš”é›¢çš„è³‡æº

- è¨Šè™Ÿé‡ï¼ˆsemaphoresï¼‰
- è¨Šæ¯ä½‡åˆ—ï¼ˆmessage queuesï¼‰
- å…±äº«è¨˜æ†¶é«”ï¼ˆshared memoryï¼‰

#### é—œéµé»

- åŒä¸€å®¹å™¨å…§çš„ç¨‹åºå¯ä»¥é€é IPC é€šè¨Š
- ä¸åŒå®¹å™¨çš„ç¨‹åºç„¡æ³•é€é IPC é€šè¨Šï¼ˆé™¤éé¡¯å¼å…±äº«ï¼‰

---

### USER Namespace

USER Namespace å…è¨±å°‡å®¹å™¨å…§çš„ä½¿ç”¨è€… ID å°æ˜ åˆ°å®¿ä¸»æ©Ÿçš„ä¸åŒä½¿ç”¨è€… IDã€‚

#### ä½œç”¨

éš”é›¢ä½¿ç”¨è€…å’Œçµ„ IDï¼Œå¯¦ç¾è¨±å¯æ¬Šéš”é›¢ã€‚

#### æ•ˆæœ

å…·é«”å…§å®¹å¦‚ä¸‹ï¼š

```
å®¹å™¨å…§                          å®¿ä¸»æ©Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UID 0 (root)   â”‚â”€â”€â”€å°æ˜ â”€â”€â”€â”€â–ºâ”‚  UID 100000     â”‚ â† éç‰¹æ¬Šä½¿ç”¨è€…
â”‚  UID 1 (daemon) â”‚â”€â”€â”€å°æ˜ â”€â”€â”€â”€â–ºâ”‚  UID 100001     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®‰å…¨æ„ç¾©

å®¹å™¨å…§çš„ root ä½¿ç”¨è€…å¯ä»¥å°æ˜ ç‚ºå®¿ä¸»æ©Ÿä¸Šçš„æ™®é€šä½¿ç”¨è€…ï¼Œå³ä½¿å®¹å™¨è¢«çªç ´ï¼Œæ”»æ“Šè€…åœ¨å®¿ä¸»æ©Ÿä¸Šä¹Ÿåªæœ‰æ™®é€šè¨±å¯æ¬Šã€‚

> ğŸ’¡ ç­†è€…å»ºè­°ï¼šç”Ÿç”¢ç’°å¢ƒå»ºè­°å•Ÿç”¨ User Namespaceï¼Œå¢å¼·å®‰å…¨æ€§ã€‚

---

### å‹•æ‰‹å¯¦é©—ï¼šé«”é©— Namespace

ä½¿ç”¨ `unshare` æŒ‡ä»¤å¯ä»¥åœ¨ä¸ä½¿ç”¨ Docker çš„æƒ…æ³ä¸‹é«”é©— Namespaceï¼š

#### å¯¦é©— 1ï¼šUTS Namespace

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å»ºç«‹æ–°çš„ UTS namespace ä¸¦å•Ÿå‹• shell

$ sudo unshare --uts /bin/bash

## ä¿®æ”¹ä¸»æ©Ÿåï¼ˆéš»å½±éŸ¿é€™å€‹ namespaceï¼‰

$ hostname container-test
$ hostname
container-test

## é€€å‡ºå¾Œæª¢è¦–å®¿ä¸»æ©Ÿä¸»æ©Ÿåï¼ˆæœªæ”¹è®Šï¼‰

$ exit
$ hostname
my-server
```

#### å¯¦é©— 2ï¼šPID Namespace

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å»ºç«‹æ–°çš„ PID å’Œ MNT namespace

$ sudo unshare --pid --mount --fork /bin/bash

## æ›è¼‰æ–°çš„ /proc

$ mount -t proc proc /proc

## æª¢è¦–ç¨‹åºï¼ˆåªèƒ½çœ‹åˆ°ç•¶å‰ shellï¼‰

$ ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0   8960  4516 pts/0    S    10:00   0:00 /bin/bash
root         8  0.0  0.0  10072  3200 pts/0    R+   10:00   0:00 ps aux
```

#### å¯¦é©— 3ï¼šNET Namespace

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
## å»ºç«‹æ–°çš„ç¶²è·¯ namespace

$ sudo unshare --net /bin/bash

## æª¢è¦–ç¶²è·¯ä»‹é¢ï¼ˆåªæœ‰ loï¼‰

$ ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
```

---

### Namespace çš„ä¾·é™æ€§

Namespace æä¾›äº†éš”é›¢ä½†ä¸æ˜¯å®‰å…¨é‚Šç•Œï¼š

| æ–¹é¢ | èªªæ˜ |
|------|------|
| **å…±äº«æ ¸å¿ƒ** | æ‰€æœ‰å®¹å™¨å…±äº«å®¿ä¸»æ©Ÿæ ¸å¿ƒï¼Œæ ¸å¿ƒæ¼æ´å¯èƒ½å½±éŸ¿æ‰€æœ‰å®¹å™¨ |
| **éƒ¨åˆ†è³‡æºæœªéš”é›¢** | /procã€/sys éƒ¨åˆ†å…§å®¹ä»å¯è¦‹ï¼›æ™‚é–“ç„¡æ³•éš”é›¢ |
| **éè™›æ“¬åŒ–** | æ¯”è™›æ“¬æ©Ÿéš”é›¢æ€§å¼± |

> éœ€è¦æ›´å¼·éš”é›¢æ™‚ï¼Œå¯è€ƒæ…® gVisorã€Kata Containers ç­‰å®‰å…¨å®¹å™¨æ–¹æ¡ˆã€‚

---

### æœ¬ç« å°çµ

| Namespace | éš”é›¢å…§å®¹ | ä¸€å¥è©±èªªæ˜ |
|-----------|---------|-----------|
| PID | ç¨‹åº ID | å®¹å™¨æœ‰è‡ªå·±çš„ç¨‹åºæ¨¹ |
| NET | ç¶²è·¯ | å®¹å™¨æœ‰è‡ªå·±çš„ IP å’Œé€£æ¥åŸ  |
| MNT | æª”æ¡ˆç³»çµ± | å®¹å™¨æœ‰è‡ªå·±çš„æ ¹ç›®éŒ„ |
| UTS | ä¸»æ©Ÿå | å®¹å™¨æœ‰è‡ªå·±çš„ hostname |
| IPC | ç¨‹åºé–“é€šè¨Š | å®¹å™¨é–“ IPC éš”é›¢ |
| USER | ä½¿ç”¨è€… ID | å®¹å™¨ root â‰  å®¿ä¸»æ©Ÿ root |

### å»¶ä¼¸é–±è®€

- [æ§åˆ¶çµ„ï¼ˆCgroupsï¼‰](14.3_cgroups.md)ï¼šè³‡æºé™åˆ¶æ©Ÿåˆ¶
- [è¯åˆæª”æ¡ˆç³»çµ±](14.4_ufs.md)ï¼šåˆ†å±¤å„²å­˜çš„å¯¦ç¾
- [å®‰å…¨](../security/README.md)ï¼šå®¹å™¨å®‰å…¨å¯¦è¸
- [Linux Namespace å®˜æ–¹æ–‡ä»¶](https://man7.org/linux/man-pages/man7/namespaces.7.html)
