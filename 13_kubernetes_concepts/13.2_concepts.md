## 13.2 基本概念

如圖 12-2 所示，Kubernetes 由控制平面與工作節點構成。

![Kubernetes 基本概念示意圖](./_images/kubernetes_design.jpg)

圖 12-2 Kubernetes 基本概念示意圖

* 節點 (`Node`)：一個節點是一個執行 Kubernetes 中的主機。
* 容器組 (`Pod`)：一個 Pod 對應於由若干容器組成的一個容器組，同個組內的容器共享一個儲存卷 (volume)。
* 容器組生命週期 (`pod-states`)：包含所有容器狀態集合，包括容器組狀態型別，容器組生命週期，事件，重啟策略，以及 replication controllers。
* Replication Controllers：主要負責指定數量的 pod 在同一時間一起執行。
* 服務 (`services`)：一個 Kubernetes 服務是容器組邏輯的高階抽象，同時也對外提供訪問容器組的策略。
* 卷 (`volumes`)：一個卷就是一個目錄，容器對其有訪問許可權。
* 標籤 (`labels`)：標籤是用來連線一組物件的，比如容器組。標籤可以被用來組織和選擇子物件。
* 介面許可權 (`accessing_the_api`)：連接埠，IP 地址和代理的防火牆規則。
* web 介面 (`ux`)：使用者可以透過 web 介面操作 Kubernetes。
* 指令行操作 (`cli`)：`kubectl` 指令。

### 13.2.1 節點

在 `Kubernetes` 中，節點是實際工作的點，節點可以是虛擬機或者物理機器，依賴於一個叢集環境。每個節點都有一些必要的服務以執行容器組，並且它們都可以透過主節點來管理。必要服務包括 Docker，kubelet 和代理服務。

#### 容器狀態

容器狀態用來描述節點的當前狀態。現在，其中包含三個訊息：

##### 主機 IP

主機 IP 需要雲平台來查詢，`Kubernetes` 把它作為狀態的一部分來儲存。如果 `Kubernetes` 沒有執行在雲平台上，節點 ID 就是必需的。IP 地址可以變化，並且可以包含多種型別的 IP 地址，如公共 IP，私有 IP，動態 IP，ipv6 等等。

##### 節點週期

通常來說節點有 `Pending`，`Running`，`Terminated` 三個週期，如果 Kubernetes 發現了一個節點並且其可用，那麼 Kubernetes 就把它標記為 `Pending`。然後在某個時刻，Kubernetes 將會標記其為 `Running`。節點的結束週期稱為 `Terminated`。一個已經 `Terminated` 的節點不會接受和排程任何請求，並且已經在其上執行的容器組也會刪除。

##### 節點狀態

節點的狀態主要是用來描述處於 `Running` 的節點。當前可用的有 `NodeReachable` 和 `NodeReady`。以後可能會增加其他狀態。`NodeReachable` 表示叢集可達。`NodeReady` 表示 kubelet 回傳 Status Ok 並且 HTTP 狀態檢查健康。

#### 節點管理

節點並非 Kubernetes 建立，而是由雲平台建立，或者就是物理機器、虛擬機。在 Kubernetes 中，節點僅僅是一條記錄，節點建立之後，Kubernetes 會檢查其是否可用。在 Kubernetes 中，節點用如下結構儲存：

```json
{
  "id": "10.1.2.3",
  "kind": "Minion",
  "apiVersion": "v1beta1",
  "resources": {
    "capacity": {
      "cpu": 1000,
      "memory": 1073741824
    },
  },
  "labels": {
    "name": "my-first-k8s-node",
  },
}
```

Kubernetes 校驗節點可用依賴於 ID。在當前的版本中，有兩個介面可以用來管理節點：節點控制和 Kube 管理。

#### 節點控制

在 Kubernetes 主節點中，節點控制器是用來管理節點的元件。主要包含：

* 叢集範圍內節點同步
* 單節點生命週期管理

節點控制有一個同步輪詢，主要監聽所有雲平台的虛擬實例，會根據節點狀態建立和刪除。可以透過 `--node_sync_period` 標誌來控制該輪詢。如果一個實例已經建立，節點控制將會為其建立一個結構。同樣的，如果一個節點被刪除，節點控制也會刪除該結構。在 Kubernetes 啟動時可用透過 `--machines` 標記來顯示指定節點。同樣可以使用 `kubectl` 來一條一條的新增節點，兩者是相同的。透過設定 `--sync_nodes=false` 標記來禁止叢集之間的節點同步，你也可以使用 api/kubectl 指令行來增刪節點。

### 13.2.2 容器組

在 Kubernetes 中，使用的最小單位是容器組，容器組是建立，排程，管理的最小單位。一個容器組使用相同的 Docker 容器並共享卷 (掛載點)。一個容器組是一個特定應用的打包集合，包含一個或多個容器。

和執行的容器類似，一個容器組被認為只有很短的執行週期。容器組被排程到一組節點執行，直到容器的生命週期結束或者其被刪除。如果節點死掉，執行在其上的容器組將會被刪除而不是重新排程。(也許在將來的版本中會新增容器組的移動)。

#### 容器組設計的初衷

容器組 (Pod) 的設計主要是為瞭解決應用間的緊密協作和資源共享問題。

#### 資源共享和通訊

容器組主要是為了資料共享和它們之間的通訊。

在一個容器組中，容器都使用相同的網路地址和連接埠，可以透過本地網路來相互通訊。每個容器組都有獨立的 IP，可用透過網路來和其他物理主機或者容器通訊。

容器組有一組儲存卷 (掛載點)，主要是為了讓容器在重啟之後可以不丟失資料。

#### 容器組管理

容器組是一個應用管理和部署的高層次抽象，同時也是一組容器的介面。容器組是部署、水平放縮的最小單位。

#### 容器組的使用

容器組可以透過組合來建立複雜的應用，其本來的意義包含：

* 內容管理，檔案和數據載入以及本地快取管理等。
* 日誌和檢查點備份，壓縮，快照等。
* 監聽資料變化，跟蹤日誌，日誌和監控代理，訊息發布等。
* 代理，網橋
* 控制器，管理，設定以及更新

#### 替代方案

為什麼不在一個單一的容器裡執行多個程式？

* 1. 透明化。為了使容器組中的容器保持一致的基礎設施和服務，比如程序管理和資源監控。這樣設計是為了使用者的便利性。
* 2. 解耦軟體之間的依賴。每個容器都可能重新建立和發布，Kubernetes 必須支援熱發布和熱更新 (將來)。
* 3. 方便使用。使用者不必執行獨立的程式管理，也不用擔心每個應用程式的退出狀態。
* 4. 高效。考慮到基礎設施有更多的職責，容器必須要輕量化。

#### 容器組的生命狀態

包括若干狀態值：`pending`、`running`、`succeeded`、`failed`。

##### pending

容器組已經被節點接受，但有一個或多個容器還沒有執行起來。這將包含某些節點正在下載映象的時間，這種情形會依賴於網路情況。

##### running

容器組已經被排程到節點，並且所有的容器都已經啟動。至少有一個容器處於執行狀態 (或者處於重啟狀態)。

##### succeeded

所有的容器都正常退出。

##### failed

容器組中所有容器都意外中斷了。

#### 容器組生命週期

通常來說，如果容器組被建立了就不會自動銷燬，除非被某種行為觸發，而觸發此種情況可能是人為，或者複製控制器所為。唯一例外的是容器組由 succeeded 狀態成功退出，或者在一定時間內重試多次依然失敗。

如果某個節點死掉或者不能連線，那麼節點控制器將會標記其上的容器組的狀態為 `failed`。

舉例如下。

* 容器組狀態 `running`，有 1 容器，容器正常退出
  * 記錄完成事件
  * 如果重啟策略為：
    * 始終：重啟容器，容器組保持 `running`
    * 失敗時：容器組變為 `succeeded`
    * 從不：容器組變為 `succeeded`
* 容器組狀態 `running`，有 1 容器，容器異常退出
  * 記錄失敗事件
  * 如果重啟策略為：
    * 始終：重啟容器，容器組保持 `running`
    * 失敗時：重啟容器，容器組保持 `running`
    * 從不：容器組變為 `failed`
* 容器組狀態 `running`，有 2 容器，有 1 容器異常退出
  * 記錄失敗事件
  * 如果重啟策略為：
    * 始終：重啟容器，容器組保持 `running`
    * 失敗時：重啟容器，容器組保持 `running`
    * 從不：容器組保持 `running`
  * 當有 2 容器退出
    * 記錄失敗事件
    * 如果重啟策略為：
      * 始終：重啟容器，容器組保持 `running`
      * 失敗時：重啟容器，容器組保持 `running`
      * 從不：容器組變為 `failed`
* 容器組狀態 `running`，容器記憶體不足
  * 標記容器錯誤中斷
  * 記錄記憶體不足事件
  * 如果重啟策略為：
    * 始終：重啟容器，容器組保持 `running`
    * 失敗時：重啟容器，容器組保持 `running`
    * 從不：記錄錯誤事件，容器組變為 `failed`
* 容器組狀態 `running`，一塊磁碟死掉
  * 殺死所有容器
  * 記錄事件
  * 容器組變為 `failed`
  * 如果容器組執行在一個控制器下，容器組將會在其他地方重新建立
* 容器組狀態 `running`，對應的節點段溢位
  * 節點控制器等到超時
  * 節點控制器標記容器組 `failed`
  * 如果容器組執行在一個控制器下，容器組將會在其他地方重新建立

### 13.2.3 Replication Controllers

> 注：Replication Controller (RC) 是早期的控制器型別，現代 Kubernetes 更推薦使用 ReplicaSet/Deployment。

### 13.2.4 服務

> 注：服務 (Service) 定義一組 Pod 的邏輯集合和訪問它們的策略。

### 13.2.5 卷

> 注：卷 (Volume) 包含可被 Pod 中容器訪問的資料的目錄。

### 13.2.6 標籤

> 注：標籤 (Label) 是附加到物件 (如 Pods) 上的鍵值對，用於組織和選擇物件子集。

### 13.2.7 介面許可權

> 注：介面許可權透過認證、授權和准入控制來保護 Kubernetes API 的訪問。

### 13.2.8 web 介面

> 注：Kubernetes Dashboard 是一個基於 Web 的使用者介面，用於管理叢集。

### 13.2.9 指令行操作

> 注：kubectl 是 Kubernetes 的指令行工具，用於與叢集進行互動。
