## 10.8 實戰 WordPress

WordPress 是全球最流行的內容管理系統（CMS）。使用 Docker Compose 可以在幾分鐘內搭建一個包含資料庫、Web 服務和持久化儲存的生產級 WordPress 環境。

---

### 專案結構

具體內容如下：

```
wordpress/
├── docker-compose.yml
├── .env                # 環境變數（敏感訊息）
└── nginx/              # 可選：反向代理設定
    └── nginx.conf
```

---

### 編寫 `docker-compose.yml`

這是一個生產可用的最小化設定：

```yaml
services:
  # 資料庫服務
  db:
    image: mysql:8.0
    container_name: wordpress_db
    restart: always
    command: 
      # 使用原生密碼認證（舊版 WP 相容性）
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wp_net

  # WordPress 服務
  wordpress:
    image: wordpress:latest
    container_name: wordpress_app
    restart: always
    ports:
      - "8000:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wp_data:/var/www/html
      # 增加上傳檔案大小限制
      - ./uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    depends_on:
      - db
    networks:
      - wp_net

volumes:
  db_data:  # 資料庫持久化
  wp_data:  # WordPress 檔案(外掛/主題/上傳)持久化

networks:
  wp_net:
```

---

### 設定檔案詳解

#### 1. 環境變數（.env）

為了安全，不要在 `docker-compose.yml` 中直接寫密碼。建立 `.env` 檔案：

```ini
DB_ROOT_PASSWORD=somestrongrootpassword
DB_PASSWORD=somestronguserpassword
```

Compose 會自動讀取此同級目錄下的檔案。

#### 2. 資料持久化

我們定義了兩個命名卷：
- `db_data`: 確保 MySQL 容器重建後資料不丟失
- `wp_data`: 儲存 WordPress 的核心檔案、外掛、主題和上傳的媒體檔案

#### 3. PHP 設定最佳化

預設的 WordPress 映象上傳檔案限制較小（通常 2MB）。建立 `uploads.ini`：

```ini
file_uploads = On
memory_limit = 256M
upload_max_filesize = 64M
post_max_size = 64M
max_execution_time = 600
```

---

### 啟動與執行

1. 啟動服務：

```bash
$ docker compose up -d
```

2. 訪問安裝介面：
   開啟瀏覽器訪問 `http://localhost:8000`

3. 檢視日誌：

```bash
$ docker compose logs -f
```

---

### 生產環境最佳實踐

#### 1. 資料庫備份

不要只依賴 Volume。建議定期備份資料庫：

```bash
## 匯出 SQL

$ docker exec wordpress_db mysqldump -u wordpress -pwordpress wordpress > backup.sql
```

或者新增一個自動備份容器：

```yaml
  backup:
    image: tiredofit/db-backup
    volumes:
      - ./backups:/backup
    environment:
      - DB_TYPE=mysql
      - DB_HOST=db
      - DB_NAME=wordpress
      - DB_USER=wordpress
      - DB_PASS=${DB_PASSWORD}
      - DB_DUMP_FREQ=1440 # 每天備份一次
    depends_on:
      - db
    networks:
      - wp_net
```

#### 2. 使用 Nginx 反向代理

在生產環境中，不要直接暴露 WordPress 連接埠，而是透過 Nginx 進行反向代理並設定 SSL。

#### 3. 使用 Redis 快取

WordPress 支援 Redis 快取以提高效能。

```yaml
  redis:
    image: redis:alpine
    restart: always
    networks:
      - wp_net
```

在 WordPress 容器環境變數中新增：
```yaml
      WORDPRESS_REDIS_HOST: redis
```
並安裝 Redis Object Cache 外掛。

---

### 常見問題

#### Q: 資料庫連線錯誤

**現象**：訪問頁面顯示 "Error establishing a database connection"。

**排查**：
1. 檢查 `docker compose logs wordpress`
2. 確認 `.env` 中的密碼與 YAML 檔案引用一致
3. 確認 `WORDPRESS_DB_HOST` 也是 `db`（服務名）
4. MySQL 8.0 可能需要幾秒鐘啟動，WordPress 會自動重試，稍等片刻即可。

#### Q: 無法上傳大檔案

**解決**：確保掛載了 `uploads.ini` 設定，並且重啟了容器：
```bash
$ docker compose restart wordpress
```

---

### 延伸閱讀

- [Compose 樣板檔案](10.5_compose_file.md)：深入瞭解設定項
- [資料卷](../08_data_network/data/volume.md)：理解資料持久化
- [Docker Hub WordPress](https://hub.docker.com/_/wordpress)：官方映象文件
