## 7.3 ADD 更高階的複製檔案

### 基本語法

具體內容如下：

```docker
ADD [選項] <源路徑>... <目標路徑>
ADD [選項] ["<源路徑>", ... "<目標路徑>"]
```

`ADD` 在 `COPY` 基礎上增加了兩個功能：
1. 自動解壓 tar 壓縮封裝
2. 支援從 URL 下載檔案（不推薦）

---

### ADD vs COPY

| 屬性 | COPY | ADD |
|------|------|-----|
| 複製本地檔案 | ✅ | ✅ |
| 自動解壓 tar | ❌ | ✅ |
| 支援 URL | ❌ | ✅（不推薦） |
| 行為可預測性 | ✅ 高 | ⚠️ 低 |
| 推薦程度 | ✅ **優先使用** | 僅解壓場景 |

> 筆者建議：除非需要自動解壓 tar 檔案，否則始終使用 COPY。明確的行為比隱式的魔法更好。

---

### 自動解壓功能

#### 基本用法

具體內容如下：

```docker
## 自動解壓 tar.gz 到目標目錄

ADD app.tar.gz /app/
```

ADD 會識別並解壓以下格式：
- `.tar`
- `.tar.gz` / `.tgz`
- `.tar.bz2` / `.tbz2`
- `.tar.xz` / `.txz`

#### 實際應用

官方基礎映象通常使用 ADD 解壓根檔案系統：

```docker
FROM scratch
ADD ubuntu-noble-core-cloudimg-amd64-root.tar.gz /
```

#### 解壓過程

具體內容如下：

```
ADD app.tar.gz /app/
        │
        ├─ 識別 .tar.gz 格式
        ├─ 自動解壓
        └─ 內容放入 /app/

app.tar.gz 包含：        /app/ 目錄結果：
├── src/                 ├── src/
│   └── main.py          │   └── main.py
└── config.json          └── config.json
```

---

### URL 下載功能（不推薦）

#### 基本用法

具體內容如下：

```docker
## 從 URL 下載檔案

ADD https://example.com/app.zip /app/app.zip
```

#### 為什麼不推薦

| 問題 | 說明 |
|------|------|
| 許可權固定 | 下載的檔案許可權為 600，通常需要額外 RUN 修改 |
| 不會解壓 | URL 下載的壓縮封裝不會自動解壓 |
| 快取問題 | URL 內容變化時不會重新下載 |
| 層數增加 | 需要額外 RUN 清理 |

#### 推薦替代方案

具體內容如下：

```docker
## ❌ 不推薦：使用 ADD 下載

ADD https://example.com/app.tar.gz /tmp/
RUN tar -xzf /tmp/app.tar.gz -C /app && rm /tmp/app.tar.gz

## ✅ 推薦：使用 RUN + curl

RUN curl -fsSL https://example.com/app.tar.gz | tar -xz -C /app
```

優勢：
- 一條 RUN 完成下載、解壓、清理
- 減少映象層數
- 更清晰的建立意圖

---

### 修改檔案所有者

具體內容如下：

```docker
ADD --chown=node:node app.tar.gz /app/
ADD --chown=1000:1000 files/ /app/
```

---

### 何時使用 ADD

#### ✅ 適合使用 ADD

具體內容如下：

```docker
## 解壓本地 tar 檔案

FROM scratch
ADD rootfs.tar.gz /

## 解壓應用套件

ADD dist.tar.gz /app/
```

#### ❌ 不適合使用 ADD

具體內容如下：

```docker
## 複製普通檔案（用 COPY）

ADD package.json /app/          # ❌
COPY package.json /app/         # ✅

## 下載檔案（用 RUN + curl）

ADD https://example.com/file /  # ❌
RUN curl -fsSL ... -o /file     # ✅

## 需要保留 tar 不解壓（用 COPY）

ADD archive.tar.gz /archives/   # ❌ 會解壓
COPY archive.tar.gz /archives/  # ✅ 保持原樣
```

---

### 快取行為

ADD 可能導致建立快取失效：

```docker
## 如果 app.tar.gz 內容變化，此層及後續層都需重建

ADD app.tar.gz /app/
RUN npm install
```

**最佳化建議**：

```docker
## 先複製依賴檔案

COPY package*.json /app/
RUN npm install

## 再新增應用程式碼

ADD app.tar.gz /app/
```

---

### 最佳實踐

#### 1. 預設使用 COPY

具體內容如下：

```docker
## ✅ 大多數場景使用 COPY

COPY . /app/
```

#### 2. 僅在需要解壓時使用 ADD

具體內容如下：

```docker
## ✅ 自動解壓場景

ADD app.tar.gz /app/
```

#### 3. 不要用 ADD 下載檔案

具體內容如下：

```docker
## ❌ 避免

ADD https://example.com/file.tar.gz /tmp/

## ✅ 推薦

RUN curl -fsSL https://example.com/file.tar.gz | tar -xz -C /app
```

#### 4. 解壓後清理

具體內容如下：

```docker
## 如果需要控制解壓過程

COPY app.tar.gz /tmp/
RUN tar -xzf /tmp/app.tar.gz -C /app && \
    rm /tmp/app.tar.gz
```

---

### 本章小結

| 場景 | 推薦指令 |
|------|---------|
| 複製普通檔案 | `COPY` |
| 複製目錄 | `COPY` |
| 自動解壓 tar | `ADD` |
| 從 URL 下載 | `RUN curl` |
| 保持 tar 不解壓 | `COPY` |

### 延伸閱讀

- [COPY 複製檔案](copy.md)：基本複製操作
- [多階段建立](../multistage-builds.md)：減少映象體積
- [最佳實踐](../../16_appendix/16.1_best_practices.md)：Dockerfile 編寫指南
