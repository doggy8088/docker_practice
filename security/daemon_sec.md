# Docker伺服器端的防護

執行一個容器或應用程式的核心是透過 Docker 伺服器端。Docker 服務的執行目前需要 root 許可權，因此其安全性十分關鍵。

首先，確保只有可信的使用者才可以訪問 Docker 服務。Docker 允許使用者在主機和容器間共享資料夾，同時不需要限制容器的訪問許可權，這就容易讓容器突破資源限制。例如，惡意使用者啟動容器的時候將主機的根目錄`/`對映到容器的 `/host` 目錄中，那麼容器理論上就可以對主機的檔案系統進行任意修改了。這聽起來很瘋狂？但是事實上幾乎所有虛擬化系統都允許類似的資源共享，而沒法禁止使用者共享主機根檔案系統到虛擬機系統。

這將會造成很嚴重的安全後果。因此，當提供容器建立服務時（例如透過一個 web 伺服器），要更加注意進行引數的安全檢查，防止惡意的使用者用特定引數來建立一些破壞性的容器。

為了加強對伺服器端的保護，Docker 的 REST API（用戶端用來跟伺服器端通訊）在 0.5.2 之後使用本地的 Unix 套接字機制替代了原先繫結在 127.0.0.1 上的 TCP 套接字，因為後者容易遭受跨站指令碼攻擊。現在使用者使用 Unix 許可權檢查來加強套接字的訪問安全。

使用者仍可以利用 HTTP 提供 REST API 訪問。建議使用安全機制，確保只有可信的網路或 VPN，或證書保護機制（例如受保護的 stunnel 和 ssl 認證）下的訪問可以進行。此外，還可以使用 [ HTTPS 和證書](https://docs.docker.com/engine/security/https/) 來加強保護。

最近改進的 Linux 命名空間機制將可以實現使用非 root 使用者來執行全功能的容器。這將從根本上解決了容器和主機之間共享檔案系統而引起的安全問題。

終極目標是改進 2 個重要的安全屬性：
* 將容器的 root 使用者 [對映到本地主機上的非 root 使用者](https://docs.docker.com/engine/security/userns-remap/)，減輕容器和主機之間因許可權提升而引起的安全問題；
* 允許 Docker 伺服器端在 [非 root 許可權(rootless 模式)](https://docs.docker.com/engine/security/rootless/) 下執行，利用安全可靠的子程序來代理執行需要特權許可權的操作。這些子程序將只允許在限定範圍內進行操作，例如僅僅負責虛擬網路設定或檔案系統管理、設定操作等。

最後，建議採用專用的伺服器來執行 Docker 和相關的管理服務（例如管理服務比如 ssh 監控和程序監控、管理工具 nrpe、collectd 等）。其它的業務服務都放到容器中去執行。
