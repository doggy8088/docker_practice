## 2.3 å€‰åº«

Docker Registry æ˜¯æ˜ è±¡åˆ†ç™¼å’Œç®¡ç†çš„æ ¸å¿ƒå…ƒä»¶ã€‚æœ¬ç¯€å°‡ä»‹ç´¹ Registry çš„åŸºæœ¬æ¦‚å¿µã€å…¬å…±å’Œç§æœ‰æœå‹™çš„é¸æ“‡ï¼Œä»¥åŠæ˜ è±¡çš„å®‰å…¨ç®¡ç†ã€‚

### 2.3.1 ä¸€å¥è©±ç†è§£ Registry

> **Docker Registry æ˜¯å„²å­˜å’Œåˆ†ç™¼ Docker æ˜ è±¡çš„æœå‹™ï¼Œé¡ä¼¼æ–¼ç¨‹å¼ç¢¼çš„ GitHub æˆ–å¥—ä»¶ç®¡ç†çš„ npmã€‚**

æ˜ è±¡å»ºç«‹å®Œæˆå¾Œï¼Œå¯ä»¥åœ¨ç•¶å‰æ©Ÿå™¨ä¸ŠåŸ·è¡Œã€‚ä½†å¦‚æœéœ€è¦åœ¨å…¶ä»–ä¼ºæœå™¨ä¸Šä½¿ç”¨é€™å€‹æ˜ è±¡ï¼Œå°±éœ€è¦ä¸€å€‹é›†ä¸­çš„å„²å­˜å’Œåˆ†ç™¼æœå‹™â€”â€”é€™å°±æ˜¯ Docker Registryã€‚

### 2.3.2 æ ¸å¿ƒæ¦‚å¿µ

è¦ç†Ÿç·´ä½¿ç”¨ Docker Registryï¼Œé¦–å…ˆéœ€è¦ç†æ¸…å®ƒèˆ‡å€‰åº« (Repository)ã€æ¨™ç±¤ (Tag) ä¹‹é–“çš„é—œä¿‚ã€‚

#### Registryã€å€‰åº«ã€æ¨™ç±¤çš„é—œä¿‚

Docker Registry ä¸­å¯ä»¥åŒ…å«å¤šå€‹ Repositoryï¼Œæ¯å€‹ Repository å¯ä»¥åŒ…å«å¤šå€‹ Tagã€‚å¦‚åœ– 2-2 æ‰€ç¤ºï¼Œå®ƒå€‘ä¹‹é–“å…·æœ‰æ¸…æ™°çš„å±¤ç´šé—œä¿‚ã€‚

```mermaid
flowchart TB
    subgraph Registry ["Docker Registryï¼ˆå¦‚ Docker Hubï¼‰"]
        direction TB
        subgraph RepoNginx ["Repositoryï¼ˆå€‰åº«ï¼‰: nginx"]
            direction LR
            N1(":latest (tag)")
            N2(":1.25 (tag)")
            N3(":1.24 (tag)")
            N4(":alpine (tag)")
            N5("...")
            N1 ~~~ N2 ~~~ N3 ~~~ N4 ~~~ N5
        end
        subgraph RepoMysql ["Repositoryï¼ˆå€‰åº«ï¼‰: mysql"]
            direction LR
            M1(":latest")
            M2(":8.0")
            M3(":5.7")
            M4("...")
            M1 ~~~ M2 ~~~ M3 ~~~ M4
        end
        RepoNginx ~~~ RepoMysql
    end
```

åœ– 2-2 Registryã€Repository èˆ‡ Tag çš„å±¤ç´šé—œä¿‚

ç›¸é—œåŸºæœ¬æ¦‚å¿µå…·é«”å¦‚ä¸‹ï¼š

| æ¦‚å¿µ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| **Registry** | å„²å­˜æ˜ è±¡çš„æœå‹™ | Docker Hubã€ghcr.io |
| **Repository (å€‰åº«)** | åŒä¸€è»Ÿé«”çš„æ˜ è±¡é›†åˆ | `nginx`ã€`mysql`ã€`mycompany/myapp` |
| **Tag (æ¨™ç±¤)** | å€‰åº«å…§çš„ç‰ˆæœ¬æ¨™è­˜ | `latest`ã€`1.25`ã€`alpine` |

#### æ˜ è±¡çš„å®Œæ•´åç¨±

ä¸€å€‹å®Œæ•´çš„ Docker æ˜ è±¡åç¨±ç”± Registry åœ°å€ã€ä½¿ç”¨è€…å/çµ„ç¹”åã€å€‰åº«åå’Œæ¨™ç±¤çµ„æˆã€‚ç­è§£å…¶çµæ§‹æœ‰åŠ©æ–¼æˆ‘å€‘æ›´æº–ç¢ºåœ°å®šä½æ˜ è±¡ã€‚åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š

```bash
[registryåœ°å€/][ä½¿ç”¨è€…å/]å€‰åº«å[:æ¨™ç±¤]
```

ç¯„ä¾‹ï¼š

```bash
## å®Œæ•´æ ¼å¼

registry.example.com/mycompany/myapp:v1.2.3
â”‚                    â”‚         â”‚     â”‚
â”‚                    â”‚         â”‚     â””â”€â”€ æ¨™ç±¤
â”‚                    â”‚         â””â”€â”€ å€‰åº«å
â”‚                    â””â”€â”€ ä½¿ç”¨è€…å/çµ„ç¹”å
â””â”€â”€ Registry åœ°å€

## Docker Hub å®˜æ–¹æ˜ è±¡ï¼ˆçœç•¥ registry å’Œä½¿ç”¨è€…åï¼‰

nginx:1.25
ubuntu:24.04

## Docker Hub ä½¿ç”¨è€…æ˜ è±¡

jwilder/nginx-proxy:latest

## å…¶ä»– Registry

ghcr.io/username/myapp:v1.0
gcr.io/google-containers/pause:3.6
```

> ğŸ’¡ **ç­†è€…æç¤º**ï¼šå¦‚æœä¸æŒ‡å®š Registry åœ°å€ï¼Œé è¨­ä½¿ç”¨ Docker Hubã€‚å¦‚æœä¸æŒ‡å®šæ¨™ç±¤ï¼Œé è¨­ä½¿ç”¨ `latest`ã€‚

### 2.3.3 å…¬å…± Registry æœå‹™

å…¬å…± Registry æœå‹™ç‚ºé–‹ç™¼è€…æä¾›äº†ä¾¿æ·çš„æ˜ è±¡ç²å–é€”å¾‘ã€‚å…¶ä¸­æœ€è‘—åçš„æ˜¯ Docker Hubã€‚

#### é è¨­çš„ Docker Hub

[Docker Hub](https://hub.docker.com/) æ˜¯æœ€å¤§çš„å…¬å…± Registryï¼Œä¹Ÿæ˜¯ Docker çš„é è¨­ Registryã€‚

**ç‰¹é»**ï¼š

- æ“æœ‰å¤§é‡[å®˜æ–¹æ˜ è±¡](https://hub.docker.com/search?q=&type=image&image_filter=official) (nginxã€mysqlã€redis ç­‰)
- å…è²»è³¬æˆ¶å¯ä»¥å»ºç«‹å…¬é–‹å€‰åº«
- ä»˜è²»è³¬æˆ¶æ”¯æ´ç§æœ‰å€‰åº«

```bash
## å¾ Docker Hub æ‹‰å–æ˜ è±¡

$ docker pull nginx              # å®˜æ–¹æ˜ è±¡
$ docker pull bitnami/redis      # ç¬¬ä¸‰æ–¹æ˜ è±¡

## æ¨é€æ˜ è±¡åˆ° Docker Hub

$ docker login
$ docker push username/myapp:v1.0
```

#### å…¶ä»–å…¬å…± Registry

é™¤äº† Docker Hubï¼Œé‚„æœ‰ä»¥ä¸‹å¹¾å€‹å¸¸è¦‹çš„å…¬å…± Registryï¼š

| Registry | åœ°å€ | èªªæ˜ |
|----------|------|------|
| **GitHub Container Registry** | ghcr.io | GitHub æä¾›ï¼Œèˆ‡ GitHub Actions æ•´åˆå¥½ |
| **Google Container Registry** | gcr.io | Google Cloud æä¾›ï¼ŒKubernetes æ˜ è±¡å¸¸ç”¨ |
| **Quay.io** | quay.io | Red Hat æä¾› |
| **é˜¿é‡Œé›²å®¹å™¨æ˜ è±¡æœå‹™** | registry.cn-*.aliyuncs.com | åœ‹å…§è¨ªå•å¿« |
| **é¨°è¨Šé›²å®¹å™¨æ˜ è±¡æœå‹™** | ccr.ccs.tencentyun.com | åœ‹å…§è¨ªå•å¿« |

### 2.3.4 æ˜ è±¡åŠ é€Ÿå™¨

ç”±æ–¼ç¶²è·¯åŸå› ï¼Œåœ¨åœ‹å…§ç›´æ¥è¨ªå• Docker Hub å¯èƒ½æœƒå¾ˆæ…¢ã€‚å¯ä»¥è¨­å®š **æ˜ è±¡åŠ é€Ÿå™¨** (Registry Mirror) ä¾†åŠ é€Ÿä¸‹è¼‰ã€‚è¨­å®šç¯„ä¾‹å¦‚ä¸‹ï¼š

```json
// /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://your-accelerator-url"
  ]
}
```

è©³ç´°è¨­å®šæ–¹æ³•è«‹åƒè€ƒ[æ˜ è±¡åŠ é€Ÿå™¨](../03_install/3.9_mirror.md)ç« ç¯€ã€‚

> âš ï¸ **ç­†è€…æé†’**ï¼šæ˜ è±¡åŠ é€Ÿå™¨çš„å¯ç”¨æ€§ç¶“å¸¸è®ŠåŒ–ï¼Œä½¿ç”¨å‰å»ºè­°å…ˆæ¸¬è©¦æ˜¯å¦å¯ç”¨ã€‚

### 2.3.5 ç§æœ‰ Registry

å‡ºæ–¼å®‰å…¨å’Œéš±ç§çš„è€ƒæ…®ï¼Œä¼æ¥­å¾€å¾€éœ€è¦æ­å»ºè‡ªå·±çš„ç§æœ‰ Registryã€‚ä»¥ä¸‹æ˜¯å¹¾ç¨®å¸¸è¦‹çš„æ­å»ºæ–¹æ¡ˆã€‚

#### å®˜æ–¹ Registry æ˜ è±¡

Docker å®˜æ–¹æä¾›äº† [registry](https://hub.docker.com/_/registry/) æ˜ è±¡ï¼Œå¯ä»¥å¿«é€Ÿæ­å»ºç§æœ‰ Registryï¼š

```bash
## å•Ÿå‹•ä¸€å€‹æœ¬åœ° Registry

$ docker run -d -p 5000:5000 --name registry registry:2

## æ¨é€æ˜ è±¡åˆ°æœ¬åœ° Registry

$ docker tag myapp:v1.0 localhost:5000/myapp:v1.0
$ docker push localhost:5000/myapp:v1.0

## å¾æœ¬åœ° Registry æ‹‰å–

$ docker pull localhost:5000/myapp:v1.0
```

#### ä¼æ¥­ç´šè§£æ±ºæ–¹æ¡ˆ

å®˜æ–¹ Registry åŠŸèƒ½è¼ƒç‚ºåŸºç¤ï¼Œä¼æ¥­ç’°å¢ƒå¸¸ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | ç‰¹é» |
|------|------|
| **[Harbor](https://goharbor.io/)** | CNCF å°ˆæ¡ˆï¼ŒåŠŸèƒ½å…¨é¢ (ä½¿ç”¨è€…ç®¡ç†ã€æ¼æ´æƒæã€æ˜ è±¡ç°½å)|
| **[Nexus Repository](../06_repository/6.4_nexus3_registry.md)** | æ”¯æ´å¤šç¨®è£½å“å‹åˆ¥ (Dockerã€Mavenã€npm ç­‰)|
| **é›²å» å•†æœå‹™** | é˜¿é‡Œé›² ACRã€é¨°è¨Šé›² TCRã€AWS ECR ç­‰ |

ç­†è€…å»ºè­°ï¼š

- å°åœ˜éšŠï¼šå¯ä»¥å…ˆç”¨å®˜æ–¹ Registryï¼Œå¤ ç”¨å³å¯
- ä¸­å¤§å‹åœ˜éšŠï¼šæ¨è–¦ Harborï¼ŒåŠŸèƒ½å®Œå–„ä¸”é–‹æºå…è²»
- å·²ä½¿ç”¨é›²æœå‹™ï¼šç›´æ¥ç”¨é›²å» å•†çš„ Registry æœå‹™æ›´çœå¿ƒ

### 2.3.6 æ˜ è±¡çš„æ¨é€å’Œæ‹‰å–

æŒæ¡æ˜ è±¡çš„æ¨é€ (Push) å’Œæ‹‰å– (Pull) æ˜¯ä½¿ç”¨ Docker Registry çš„åŸºæœ¬åŠŸã€‚

#### å®Œæ•´å·¥ä½œæµç¨‹

å¦‚åœ– 2-3 æ‰€ç¤ºï¼Œæ˜ è±¡å¾é–‹ç™¼ç’°å¢ƒå»ºç«‹å¾Œæ¨é€åˆ° Registryï¼Œå†ç”±ç”Ÿç”¢ç’°å¢ƒæ‹‰å–ä¸¦åŸ·è¡Œã€‚

```bash
é–‹ç™¼è€…æ©Ÿå™¨                    Registry                    ç”Ÿç”¢ä¼ºæœå™¨
     â”‚                           â”‚                             â”‚
     â”‚  docker build             â”‚                             â”‚
     â”‚  å»ºç«‹æ˜ è±¡                  â”‚                             â”‚
     â”‚                           â”‚                             â”‚
     â”‚  docker push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                             â”‚
     â”‚  æ¨é€æ˜ è±¡                  â”‚  å„²å­˜æ˜ è±¡                   â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ docker pull â”‚
     â”‚                           â”‚                  æ‹‰å–æ˜ è±¡    â”‚
     â”‚                           â”‚                             â”‚
     â”‚                           â”‚                  docker run â”‚
     â”‚                           â”‚                  åŸ·è¡Œå®¹å™¨    â”‚
```

åœ– 2-3 æ˜ è±¡å»ºç«‹ã€æ¨é€èˆ‡æ‹‰å–æµç¨‹

#### å¸¸ç”¨æŒ‡ä»¤

```bash
## ç™»å…¥ Registry

$ docker login                      # ç™»å…¥ Docker Hub
$ docker login registry.example.com # ç™»å…¥å…¶ä»– Registry

## æ‹‰å–æ˜ è±¡

$ docker pull nginx:1.25

## æ¨™è¨˜æ˜ è±¡ï¼ˆæº–å‚™æ¨é€ï¼‰

$ docker tag myapp:latest registry.example.com/myteam/myapp:v1.0

## æ¨é€æ˜ è±¡

$ docker push registry.example.com/myteam/myapp:v1.0

## ç™»å‡º

$ docker logout
```

### 2.3.7 æ˜ è±¡çš„å®‰å…¨æ€§

åœ¨ä½¿ç”¨å…¬å…±æ˜ è±¡æˆ–ç¶­è­·ç§æœ‰æ˜ è±¡æ™‚ï¼Œå®‰å…¨æ€§æ˜¯ä¸å®¹å¿½è¦–çš„é‡è¦ç’°ç¯€ã€‚

#### ä½¿ç”¨å®˜æ–¹æ˜ è±¡

Docker Hub çš„[å®˜æ–¹æ˜ è±¡](https://hub.docker.com/search?q=&type=image&image_filter=official) (æ¨™æœ‰ ã€Official Imageã€ æ¨™è­˜) ç¶“é Docker åœ˜éšŠç¨½æ ¸ï¼Œç›¸å°æ›´å®‰å…¨ã€‚ç¯„ä¾‹å¦‚ä¸‹ï¼š

```bash
## å®˜æ–¹æ˜ è±¡ç¯„ä¾‹

nginx          # âœ… å®˜æ–¹
mysql          # âœ… å®˜æ–¹
redis          # âœ… å®˜æ–¹

## ç¬¬ä¸‰æ–¹æ˜ è±¡ï¼ˆéœ€è¦è‡ªè¡Œè©•ä¼°å¯ä¿¡åº¦ï¼‰

bitnami/redis  # âš ï¸ éœ€è¦è©•ä¼°
someuser/myapp # âš ï¸ éœ€è¦è©•ä¼°
```

#### æ˜ è±¡ç°½å

ç•¶å‰æ›´æ¨è–¦ä½¿ç”¨ Sigstore / Notation é«”ç³»é€²è¡Œæ˜ è±¡ç°½åèˆ‡é©—è­‰ã€‚`Docker Content Trust (DCT)` å·²é€²å…¥é€€å ´éšæ®µï¼Œä¸å»ºè­°ä½œç‚ºæ–°å°ˆæ¡ˆä¸»æ–¹æ¡ˆã€‚

> æ³¨æ„ï¼šCosign é è¨­æœƒæŠŠç°½åå¯«å›æ˜ è±¡æ‰€åœ¨å€‰åº«ï¼Œè«‹ä½¿ç”¨ä½ æœ‰æ¨é€è¨±å¯æ¬Šçš„æ˜ è±¡åœ°å€ã€‚

```bash
## æº–å‚™ä¸€å€‹ä½ æœ‰å¯«è¨±å¯æ¬Šçš„æ˜ è±¡åœ°å€
$ export IMAGE=<ä½ çš„å€‰åº«å>/nginx:1.27
$ docker pull nginx:1.27
$ docker tag nginx:1.27 $IMAGE
$ docker push $IMAGE

## ç”Ÿæˆç°½åé‡‘é‘°ï¼ˆæœƒç”Ÿæˆ cosign.key / cosign.pubï¼‰
$ cosign generate-key-pair

## ä½¿ç”¨ Cosign ç°½åèˆ‡é©—è­‰
$ cosign sign --key cosign.key $IMAGE
$ cosign verify --key cosign.pub $IMAGE
```

#### æ¼æ´æƒæ

```bash
## ä½¿ç”¨ Docker Scout æƒææ˜ è±¡æ¼æ´

$ docker scout cves nginx:latest

## ä½¿ç”¨ Trivyï¼ˆé–‹æºå·¥å…·ï¼‰

$ trivy image nginx:latest
```
